<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Mercap</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/logo.ico">
    
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <%- include('../partials/header') %>
    
    <div class="app-container">
        <main class="main-content">
            <div class="content-area">
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap; margin-bottom: 16px;">
                        <h1 class="page-title" style="margin: 0; color: #5f6368;">Calculadora</h1>
                        <!-- Panel de Fecha Valuación (siempre visible) -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="form-label" style="font-size: 14px; margin: 0; white-space: nowrap;">Fecha Valuación:</label>
                            <div class="date-input-wrapper" style="position: relative;">
                                <input type="text" class="input input-sm date-input" id="fechaValuacion" placeholder="DD/MM/AAAA" maxlength="10" style="width: 140px;" />
                                <button type="button" class="date-picker-icon-btn" onclick="abrirDatePicker('fechaValuacion')" title="Seleccionar fecha">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <!-- Panel solo para ajuste CER (CER Valuación) -->
                        <div id="panelCERValuacion" style="display: none; align-items: center; gap: 8px;">
                            <label class="form-label" style="font-size: 14px; margin: 0; white-space: nowrap;">CER Valuación:</label>
                            <input type="text" class="input input-sm" id="cerValuacion" readonly style="width: 120px; background-color: #f1f3f4; cursor: not-allowed;" />
                        </div>
                        <!-- Panel solo para sin ajuste CER (Decimales Renta TNA) -->
                        <div id="panelDecimalesRentaTNA" style="display: none; align-items: center; gap: 8px;">
                            <label for="decimalesRentaTNA" class="form-label" style="font-size: 14px; margin: 0; white-space: nowrap;">Decimales Renta TNA:</label>
                            <input type="number" id="decimalesRentaTNA" min="0" max="12" value="4" style="width: 60px; padding: 4px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; text-align: center;" onchange="actualizarDecimalesRentaTNA()" />
                        </div>
                    </div>
                    <div id="coeficientesCERContainer" style="display: none; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <div class="resultado-item-horizontal" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px;">
                            <span style="font-size: 14px; font-weight: 500; white-space: nowrap;">Coef. CER Emisión:</span>
                            <span id="coefCEREmision" style="font-size: 14px; color: #202124;">-</span>
                        </div>
                        <div class="resultado-item-horizontal" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px;">
                            <span style="font-size: 14px; font-weight: 500; white-space: nowrap;">Coef. CER Compra:</span>
                            <span id="coefCERCompra" style="font-size: 14px; color: #202124;">-</span>
                        </div>
                        <div class="resultado-item-horizontal" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px;">
                            <span style="font-size: 14px; font-weight: 500; white-space: nowrap;">CER Emisión:</span>
                            <span id="valorCEREmision" style="font-size: 14px; color: #202124;">-</span>
                        </div>
                        <div class="resultado-item-horizontal" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px;">
                            <span style="font-size: 14px; font-weight: 500; white-space: nowrap;">CER Compra:</span>
                            <span id="valorCERCompra" style="font-size: 14px; color: #202124;">-</span>
                        </div>
                        <div class="resultado-item-horizontal" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f3f4; border-radius: 4px;">
                            <label for="decimalesAjustes" style="font-size: 14px; font-weight: 500; white-space: nowrap; margin: 0;">Decimales:</label>
                            <input type="number" id="decimalesAjustes" min="0" max="12" value="8" style="width: 60px; padding: 4px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; text-align: center;" onchange="actualizarDecimalesAjustes()" />
                        </div>
                    </div>
                </div>

                <!-- Tabla de Cupones (oculta inicialmente) -->
                <div id="tablaCuponesContainer" style="display: none; margin-bottom: 24px;">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="font-size: 20px; font-weight: 500; margin: 0; color: #e65100;">Cupones</h2>
                            <button class="btn btn-primary" onclick="agregarFilaCupon()" style="min-width: auto;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                <span>Agregar Cupón</span>
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="cupones-table" id="tablaCupones">
                                <thead>
                                    <tr>
                                        <th style="min-width: 50px;">Cupón</th>
                                        <th>Fecha<br>Inicio</th>
                                        <th>Fecha Fin<br>Dev</th>
                                        <th>Fecha<br>Liquid.</th>
                                        <th>Inicio<br>Intervalo</th>
                                        <th>Final<br>Intervalo</th>
                                        <th class="columna-cer-inicio" style="display: none;">Valor CER<br>Inicio</th>
                                        <th class="columna-cer-final" style="display: none;">Valor CER<br>Final</th>
                                        <th class="columna-promedio-tasa" style="display: none;">Promedio<br>tasa</th>
                                        <th>Day Count<br>Factor</th>
                                        <th>Amortiz.</th>
                                        <th>Valor<br>Residual</th>
                                        <th>Amortiz.<br>Ajustada</th>
                                        <th>Renta<br>Nominal</th>
                                        <th>Renta<br>TNA</th>
                                        <th>Renta<br>Ajustada</th>
                                        <th>Factor<br>Actualiz.</th>
                                        <th>Pagos<br>Actualiz.</th>
                                        <th>Flujos</th>
                                        <th>Flujos<br>Desc.</th>
                                        <th style="min-width: 60px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cuponesBody">
                                    <!-- Las filas se agregarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: flex-end; align-items: center; border-top: 1px solid var(--border-color); margin-top: 16px; padding-top: 16px;">
                            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">TIR:</span>
                                    <div id="resultadoTIR" style="font-size: 22px; font-weight: 600; color: #1e8e3e; min-width: 100px; text-align: right;">-</div>
                                </div>
                                <button class="btn btn-primary" id="btnCalcularTIR" onclick="calcularTIR()" style="display: inline-flex; gap: 8px; align-items: center; min-width: 150px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                                    </svg>
                                    <span>Calcular TIR</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Resultados (oculto inicialmente, se muestra después de calcular TIR) -->
                <div id="panelResultados" style="display: none; margin-top: 24px; margin-bottom: 24px;">
                    <div class="card">
                        <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 16px; color: #1e8e3e;">Resultados</h3>
                        
                        <div style="display: flex; flex-wrap: nowrap; gap: 12px; overflow-x: auto;">
                            <div class="resultado-item-horizontal">
                                <span class="resultado-label">Precio C+T</span>
                                <span class="resultado-valor" id="precioCT">-</span>
                            </div>
                            
                            <!-- Solo para calculadoras con ajuste CER -->
                            <div class="resultado-item-horizontal" id="precioCTAjustadoContainer" style="display: none;">
                                <span class="resultado-label">Precio C+T Ajustado</span>
                                <span class="resultado-valor" id="precioCTHoyAjustado">-</span>
                            </div>
                            
                            <div class="resultado-item-horizontal">
                                <span class="resultado-label">Pagos Efect. Actualizados</span>
                                <span class="resultado-valor" id="pagosEfectActualizados">-</span>
                            </div>
                            
                            <div class="resultado-item-horizontal" style="background: rgba(30, 142, 62, 0.15);">
                                <span class="resultado-label">Precio Ajustado - Pagos</span>
                                <span class="resultado-valor" id="precioCTAjustPagos">-</span>
                            </div>
                            
                            <div class="resultado-item-horizontal" style="background: rgba(30, 142, 62, 0.15);">
                                <span class="resultado-label">Precio Técnico Venc.</span>
                                <span class="resultado-valor" id="precioTecnicoVencimiento">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de paneles: Datos de Partida y Especie -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Panel izquierdo: Datos de Partida (1/3) -->
                    <div>
                        <div class="card" style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 12px; color: #e65100;">Datos Partida</h3>
                            
                            <div class="form-group">
                                <label class="form-label" style="font-size: 13px;">Fecha Compra</label>
                                <div class="date-input-wrapper">
                                    <input type="text" class="input input-sm date-input" id="fechaCompra" placeholder="DD/MM/AAAA" maxlength="10" required />
                                    <button type="button" class="date-picker-icon-btn" onclick="abrirDatePicker('fechaCompra')" title="Seleccionar fecha">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="font-size: 13px;">Precio Compra</label>
                                <input type="text" class="input input-sm" id="precioCompra" placeholder="Ej: 100.50" required />
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="font-size: 13px;">Cantidad Partida</label>
                                <input type="number" class="input input-sm" id="cantidadPartida" step="1" required />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel derecho: Datos de Especie (2/3) -->
                    <div>
                        <div class="card" style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 12px; color: #e65100;">Datos Especie</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start;">
                                <!-- Columna izquierda -->
                                <div style="display: flex; flex-direction: column;">
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Ticker</label>
                                        <input type="text" class="input input-sm" id="ticker" placeholder="Ej: TX26" required />
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Tasa</label>
                                        <select class="input input-sm input-opcional" id="tasa">
                                            <option value="">Seleccionar...</option>
                                            <option value="badlar">BADLAR</option>
                                            <option value="tamar">TAMAR</option>
                                            <option value="tasa-fija">Tasa fija</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Fórmula</label>
                                        <select class="input input-sm input-opcional" id="formula">
                                            <option value="">Seleccionar...</option>
                                            <option value="promedio-aritmetico">Promedio Aritmético</option>
                                            <option value="promedio-n-tasas">Promedio N tasas</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div>
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">% tasa fija</label>
                                                <input type="text" class="input input-sm input-opcional" id="rentaTNA" disabled style="cursor: not-allowed;" />
                                            </div>
                                            <div>
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Spread</label>
                                                <input type="text" class="input input-sm input-opcional" id="spread" />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Base para contar días</label>
                                        <select class="input input-sm" id="tipoInteresDias" required>
                                            <option value="0">US (NASD) 30/360</option>
                                            <option value="1">Real/real (Actual/actual)</option>
                                            <option value="2">Real/360 (Actual/360)</option>
                                            <option value="3">Real/365 (Actual/365)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Columna derecha -->
                                <div style="display: flex; flex-direction: column;">
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Fecha Emisión</label>
                                        <div class="date-input-wrapper">
                                            <input type="text" class="input input-sm date-input" id="fechaEmision" placeholder="DD/MM/AAAA" maxlength="10" required />
                                            <button type="button" class="date-picker-icon-btn" onclick="abrirDatePicker('fechaEmision')" title="Seleccionar fecha">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                                            <div style="flex: 1;">
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Dia de Pago</label>
                                                <input type="number" class="input input-sm" id="fechaPrimeraRenta" placeholder="Ej: 27" min="1" max="31" required />
                                            </div>
                                            <div style="flex: 0 0 100px;">
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Fin Dev.</label>
                                                <input type="number" class="input input-sm" id="diasRestarFechaFinDev" value="-1" step="1" required />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                                            <div style="flex: 1;">
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Fecha Amortización</label>
                                                <div class="date-input-wrapper">
                                                    <input type="text" class="input input-sm date-input" id="fechaAmortizacion" placeholder="DD/MM/AAAA" maxlength="10" required />
                                                    <button type="button" class="date-picker-icon-btn" onclick="abrirDatePicker('fechaAmortizacion')" title="Seleccionar fecha">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            <div style="flex: 0 0 60px;">
                                                <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">%</label>
                                                <input type="text" class="input input-sm" id="porcentajeAmortizacion" required />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Periodicidad</label>
                                        <select class="input input-sm" id="periodicidad" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="mensual">Mensual</option>
                                            <option value="bimestral">Bimestral</option>
                                            <option value="trimestral">Trimestral</option>
                                            <option value="semestral">Semestral</option>
                                            <option value="anual">Anual</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" style="font-size: 13px; margin-bottom: 4px;">Intervalo Inicio/Fin (días)</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: center;">
                                            <div>
                                                <input type="number" class="input input-sm input-opcional" id="intervaloInicio" step="1" placeholder="Ej: -10" />
                                            </div>
                                            <div>
                                                <input type="number" class="input input-sm input-opcional" id="intervaloFin" step="1" placeholder="Ej: -10" />
                                            </div>
                                            <div style="display: flex; align-items: center;">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: var(--text-secondary);">
                                                    <input type="checkbox" id="ajusteCER" style="margin-right: 6px; width: 18px; height: 18px; cursor: pointer;" />
                                                    <span>Ajuste CER</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botón Cargar Cupones abajo a la derecha -->
                            <div style="display: flex; justify-content: flex-end; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <button class="btn btn-success" onclick="cargarCupones()" id="btnCargarCupones">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                    </svg>
                                    <span>Cargar Cupones</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/main.js"></script>
    <script src="/js/utils/dateUtils.js"></script>
    <script src="/js/utils/formUtils.js"></script>
    <script src="/js/utils/calculosFinancieros.js"></script>
    <!-- Módulos de cupones (estructura preparada para lógica compleja) -->
    <script src="/js/calculadora/cupones/dayCountFactor.js"></script>
    <script src="/js/calculadora/cupones/diasHabiles.js"></script>
    <script src="/js/calculadora/cupones/cer.js"></script>
    <script src="/js/calculadora/cupones/recalculos.js"></script>
    <script src="/js/calculadora/cupones/core.js"></script>
    <script src="/js/calculadora/cupones/calculoCupones.js"></script>
    <script src="/js/calculadora/precios.js"></script>
    <script src="/js/calculadora/cupones/autocompletado.js"></script>
    <script src="/js/calculadora/cupones/calculos.js"></script>
    <script src="/js/calculadora/cupones/tir.js"></script>
    <script src="/js/calculadora/cupones/fechas.js"></script>
    <script src="/js/calculadora/cupones/validaciones.js"></script>
    <!-- Módulo de cálculos CER -->
    <script src="/js/calculadora/calculadoraCER.js"></script>
    <!-- Compatibilidad: mantener cupones.js por ahora -->
    <script src="/js/cupones.js"></script>
    <script src="/js/calculadoraStorage.js"></script>
</body>
</html>

